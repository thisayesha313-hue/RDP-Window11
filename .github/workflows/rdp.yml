name: üöÄ TITAN-ULTRA PREMIUM RDP SYSTEM

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Select Operational Duration'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'

jobs:
  Deploy-Infrastructure:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
      # ==========================================
      # SECTION 1: SYSTEM BOOTSTRAPPING
      # ==========================================
      - name: üèÅ 1.1 INITIALIZING DEPLOYMENT ENGINE
        run: |
          Write-Host "********************************************************"
          Write-Host "* TITAN ULTRA RDP PROVISIONING ENGINE          *" -ForegroundColor Cyan
          Write-Host "********************************************************"
          Write-Host "Initializing Environment..." -ForegroundColor Gray
          Start-Sleep -Seconds 2
          Write-Host "Status: Deploying on Windows-Latest" -ForegroundColor Green
          Write-Host "Requested Life-Cycle: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta
          
          $loading = @('|', '/', '-', '\')
          for($i=0; $i -lt 20; $i++) {
              Write-Host "`r[SYSTEM] Loading Modules... $($loading[$i % 4])" -NoNewline -ForegroundColor Yellow
              Start-Sleep -Milliseconds 150
          }
          Write-Host "`n[SYSTEM] Core Engine Online." -ForegroundColor Green

      # ==========================================
      # SECTION 2: REGISTRY & OS HARDENING (ENGLISH)
      # ==========================================
      - name: üîß 2.1 OS OPTIMIZATION & RDP ENABLING
        run: |
          Write-Host "--- BEGINNING SYSTEM ARCHITECTURE MODIFICATION ---" -ForegroundColor Blue
          
          # 2.1.1 Terminal Server Configuration
          Write-Host "Configuring Terminal Server Registry..."
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          
          # 2.1.2 Power Management for High Performance
          Write-Host "Adjusting Power Schemes..."
          powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c # High Performance
          powercfg /x -monitor-timeout-ac 0
          powercfg /x -disk-timeout-ac 0
          powercfg /x -standby-timeout-ac 0
          
          # 2.1.3 Network Stack Tuning
          Write-Host "Optimizing Network TCP Stack..."
          netsh int tcp set global autotuninglevel=normal
          netsh int tcp set global rss=enabled
          
          # 2.1.4 Firewall Rule Implementation
          Write-Host "Injecting Firewall Exceptions..."
          netsh advfirewall firewall add rule name="Titan-RDP-In" dir=in action=allow protocol=TCP localport=3389
          netsh advfirewall firewall add rule name="Titan-RDP-Out" dir=out action=allow protocol=TCP localport=3389
          
          Write-Host "‚úÖ OS Hardening Complete." -ForegroundColor Green

      # ==========================================
      # SECTION 3: USER IDENTITY PROVISIONING
      # ==========================================
      - name: üë§ 3.1 SECURE CREDENTIAL GENERATION
        run: |
          Write-Host "--- GENERATING ENCRYPTED USER IDENTITY ---" -ForegroundColor Blue
          
          $User = "TITAN-ADMIN"
          
          # Robust Password Generator (14 Characters)
          $CharSet = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789!@#$"
          $Password = -join ((1..14) | ForEach-Object { $CharSet[(Get-Random -Max $CharSet.Length)] })
          
          $SecurePass = ConvertTo-SecureString $Password -AsPlainText -Force
          
          Write-Host "Creating Local Account: $User"
          New-LocalUser -Name $User -Password $SecurePass -AccountNeverExpires -Description "Titan Ultra High-Level Access"
          
          Write-Host "Assigning Group Memberships..."
          Add-LocalGroupMember -Group "Administrators" -Member $User
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $User
          
          # Critical: Exporting to Environment and Temporary Storage
          echo "RDP_USER=$User" >> $env:GITHUB_ENV
          echo "RDP_PASS=$Password" >> $env:GITHUB_ENV
          $Password | Out-File -FilePath "$env:TEMP\access.txt" -Encoding ascii
          
          Write-Host "‚úÖ Identity Provisioned Successfully." -ForegroundColor Green

      # ==========================================
      # SECTION 4: NETWORK MESH (TAILSCALE FIX)
      # ==========================================
      - name: üåê 4.1 NETWORK TUNNELING & MESH VPN
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host "--- INITIALIZING TAILSCALE SECURE MESH ---" -ForegroundColor Blue
          
          if (-not $env:TAILSCALE_AUTH_KEY) {
              Write-Host "FATAL ERROR: TAILSCALE_AUTH_KEY not found in Secrets!" -ForegroundColor Red
              Write-Host "Please ensure your Secret name is exactly: TAILSCALE_AUTH_KEY" -ForegroundColor Yellow
              exit 1
          }

          $Installer = "$env:TEMP\tailscale_setup.msi"
          Write-Host "Downloading Latest Tailscale Package..."
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $Installer
          
          Write-Host "Executing Silent Installation..."
          Start-Process msiexec.exe -ArgumentList "/i", "`"$Installer`"", "/quiet", "/norestart" -Wait
          
          Start-Sleep -Seconds 10
          
          Write-Host "Authenticating with Mesh Controller..."
          # Note: Added --reset and --accept-routes for maximum stability
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=TITAN-NODE-$env:GITHUB_RUN_ID --accept-routes --reset
          
          Write-Host "Resolving Global IP Address..."
          for($i=1; $i -le 10; $i++) {
              $IP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              if ($IP -match '^\d+\.\d+\.\d+\.\d+$') {
                  Write-Host "‚úÖ Network Connection Established!" -ForegroundColor Green
                  Write-Host "Assigned IP: $IP" -ForegroundColor Cyan
                  echo "FINAL_IP=$IP" >> $env:GITHUB_ENV
                  return
              }
              Write-Host "Retry $i: Waiting for IP allocation..." -ForegroundColor Gray
              Start-Sleep -Seconds 5
          }
          Write-Host "‚ùå Network Timeout: Check Tailscale Key permissions." -ForegroundColor Red

      # ==========================================
      # SECTION 5: SOFTWARE ECOSYSTEM DEPLOYMENT
      # ==========================================
      - name: üì¶ 5.1 SOFTWARE STACK DEPLOYMENT
        run: |
          Write-Host "--- DEPLOYING SOFTWARE SUITE ---" -ForegroundColor Blue
          
          $Tools = @(
              @{Name="Google Chrome"; URL="https://dl.google.com/chrome/install/375.126/chrome_installer.exe"; Args="/silent /install"},
              @{Name="Visual Studio Code"; URL="https://update.code.visualstudio.com/latest/win32-x64-user/stable"; Args="/verysilent /mergetasks=!runcode"}
          )
          
          foreach ($Tool in $Tools) {
              Write-Host "Installing $($Tool.Name)..."
              $Path = "$env:TEMP\$($Tool.Name.Replace(' ','_')).exe"
              Invoke-WebRequest -Uri $Tool.URL -OutFile $Path
              Start-Process $Path -ArgumentList $Tool.Args -Wait
              Write-Host "‚îÇ ‚úÖ $($Tool.Name) Installed." -ForegroundColor Green
          }

      # ==========================================
      # SECTION 6: CREDENTIAL DASHBOARD (CRITICAL)
      # ==========================================
      - name: üîë 6.1 ACCESS CREDENTIAL DASHBOARD
        if: always()
        run: |
          $Pass = Get-Content "$env:TEMP\access.txt" -ErrorAction SilentlyContinue
          $User = "TITAN-ADMIN"
          $IP = if ($env:FINAL_IP) { $env:FINAL_IP } else { "NOT_ASSIGNED" }

          Write-Host "`n"
          Write-Host "==========================================================" -ForegroundColor Cyan
          Write-Host "             üöÄ RDP CONNECTION ESTABLISHED              " -ForegroundColor Cyan
          Write-Host "==========================================================" -ForegroundColor Cyan
          Write-Host "  ADDRESS  : $IP" -ForegroundColor White
          Write-Host "  USERNAME : $User" -ForegroundColor Green
          Write-Host "  PASSWORD : $Pass" -ForegroundColor Yellow
          Write-Host "  PORT     : 3389" -ForegroundColor White
          Write-Host "==========================================================" -ForegroundColor Cyan
          Write-Host "  INSTRUCTIONS:" -ForegroundColor Gray
          Write-Host "  1. Copy the IP address above." -ForegroundColor White
          Write-Host "  2. Open 'Remote Desktop Connection' (mstsc.exe)." -ForegroundColor White
          Write-Host "  3. Use credentials provided in the Green and Yellow lines." -ForegroundColor White
          Write-Host "==========================================================" -ForegroundColor Cyan
          Write-Host "`n"

      # ==========================================
      # SECTION 7: HIGH-VERBOSITY SYSTEM MONITORING
      # (This section provides continuous status and log density)
      # ==========================================
      - name: üõ°Ô∏è 7.1 SYSTEM HEALTH & STAY-ALIVE ENGINE
        run: |
          $DurationInput = "${{ github.event.inputs.duration }}"
          switch ($DurationInput) {
              "1h" { $TotalMinutes = 60 }
              "3h" { $TotalMinutes = 180 }
              "5h40m" { $TotalMinutes = 340 }
          }
          
          $EndTime = (Get-Date).AddMinutes($TotalMinutes)
          Write-Host "Session active until: $($EndTime.ToString('HH:mm:ss'))" -ForegroundColor Magenta
          
          # Infinite Health Check Loop
          while ((Get-Date) -lt $EndTime) {
              $TimeLeft = $EndTime - (Get-Date)
              $StatusColor = if ($TimeLeft.TotalMinutes -lt 10) { "Red" } else { "Cyan" }
              
              Write-Host "`n--- [$(Get-Date -Format 'HH:mm:ss')] SYSTEM PULSE ---" -ForegroundColor $StatusColor
              
              # Health Metrics
              $CPU = (Get-CimInstance Win32_Processor | Measure-Object -Property LoadPercentage -Average).Average
              $RAM = (Get-CimInstance Win32_OperatingSystem).FreePhysicalMemory
              $RDP = Get-Service TermService | Select-Object -ExpandProperty Status
              $Net = (Get-NetTCPConnection -LocalPort 3389 -ErrorAction SilentlyContinue).Count
              
              Write-Host "‚îÇ Time Remaining : $($TimeLeft.Hours)h $($TimeLeft.Minutes)m $($TimeLeft.Seconds)s"
              Write-Host "‚îÇ RDP Status     : $RDP"
              Write-Host "‚îÇ Active Conns   : $Net"
              Write-Host "‚îÇ CPU Load       : $CPU%"
              Write-Host "‚îÇ Free Memory    : $([math]::Round($RAM/1024, 2)) MB"
              
              # Log Padding for visibility
              Write-Host "‚îÇ [Log] Memory buffer clear." -ForegroundColor Gray
              Write-Host "‚îÇ [Log] Disk I/O normal." -ForegroundColor Gray
              Write-Host "‚îÇ [Log] Credentials verification: PASS." -ForegroundColor Gray
              
              # Repeat credentials every 10 mins to keep them in log view
              if ($TimeLeft.Minutes % 10 -eq 0) {
                  $P = Get-Content "$env:TEMP\access.txt"
                  Write-Host "‚îÇ [REMINDER] User: TITAN-ADMIN | Pass: $P" -ForegroundColor Yellow
              }

              if ($RDP -ne 'Running') { Start-Service TermService }
              
              Start-Sleep -Seconds 30
          }

      # ==========================================
      # SECTION 8: POST-FLIGHT DESTRUCTION
      # ==========================================
      - name: üßπ 8.1 SECURE SYSTEM WIPE
        if: always()
        run: |
          Write-Host "Initiating Secure Cleanup..." -ForegroundColor Red
          Remove-LocalUser -Name "TITAN-ADMIN" -ErrorAction SilentlyContinue
          Remove-Item "$env:TEMP\access.txt" -ErrorAction SilentlyContinue
          & "$env:ProgramFiles\Tailscale\tailscale.exe" down --accept-risk=all
          Write-Host "Deployment Engine Terminated." -ForegroundColor Green