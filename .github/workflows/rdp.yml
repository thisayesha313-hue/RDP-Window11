name: üöÄ TITAN PREMIUM RDP - HARDCODED KEY EDITION

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Selection: 1h, 3h, or 5h40m'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'

jobs:
  Build-Infrastructure:
    runs-on: windows-latest
    timeout-minutes: 360
    
    # GLOBAL VARIABLES - YOUR KEY IS PLACED HERE
    env:
      DIRECT_TS_KEY: "tskey-auth-ksRWYPH7MQ11CNTRL-uewqrX3LHqGAmwvBz3QGqGVgdNFSUx8Dg"
      USER_IDENTITY: "TITAN-ADMIN"

    steps:
      # ========================================================================
      # PHASE 1: BOOTSTRAPPING & ENVIRONMENT PREPARATION
      # ========================================================================
      - name: üèÅ 1.1 SYSTEM INITIALIZATION
        run: |
          Write-Host "==========================================================" -ForegroundColor Cyan
          Write-Host "         TITAN ULTIMATE RDP DEPLOYMENT ENGINE             " -ForegroundColor Cyan
          Write-Host "==========================================================" -ForegroundColor Cyan
          Write-Host "[INFO] Initializing English Language Environment..."
          Write-Host "[INFO] Hardcoded Security Mode Active."
          Write-Host "[INFO] Requested Runtime: ${{ github.event.inputs.duration }}"
          
          $load = @('---','\','|','/')
          for($i=0; $i -lt 15; $i++) {
              Write-Host "`r[LOADER] Verifying Hardware integrity... $($load[$i % 4])" -NoNewline -ForegroundColor Yellow
              Start-Sleep -Milliseconds 150
          }
          Write-Host "`n[OK] Hardware Check Passed." -ForegroundColor Green

      # ========================================================================
      # PHASE 2: REGISTRY HARDENING & RDP CONFIGURATION
      # ========================================================================
      - name: üîß 2.1 ADVANCED SYSTEM OPTIMIZATION
        run: |
          Write-Host "--- APPLYING SYSTEM ARCHITECTURE CHANGES ---" -ForegroundColor Blue
          
          # Enable Remote Desktop via Registry
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          
          # Power Management - High Performance
          powercfg /x -monitor-timeout-ac 0
          powercfg /x -disk-timeout-ac 0
          powercfg /x -standby-timeout-ac 0
          powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
          
          # Firewall Injection for Port 3389
          netsh advfirewall firewall add rule name="Titan-RDP-In" dir=in action=allow protocol=TCP localport=3389
          
          Write-Host "‚úÖ System parameters updated." -ForegroundColor Green

      # ========================================================================
      # PHASE 3: USER PROVISIONING
      # ========================================================================
      - name: üë§ 3.1 CREDENTIAL ARCHITECTURE
        run: |
          Write-Host "--- GENERATING SECURE ACCESS TOKENS ---" -ForegroundColor Blue
          
          $Username = $env:USER_IDENTITY
          $CharSet = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789!@#%"
          $Password = -join ((1..14) | ForEach-Object { $CharSet[(Get-Random -Max $CharSet.Length)] })
          
          # Save for later use in Section 6
          $Password | Out-File -FilePath "$env:TEMP\rdp_creds.txt" -Encoding ascii
          
          $SecurePass = ConvertTo-SecureString $Password -AsPlainText -Force
          New-LocalUser -Name $Username -Password $SecurePass -AccountNeverExpires -Description "Titan Global Access"
          Add-LocalGroupMember -Group "Administrators" -Member $Username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $Username
          
          Write-Host "‚úÖ Identity Provisioned." -ForegroundColor Green

      # ========================================================================
      # PHASE 4: NETWORK TUNNELING (USING HARDCODED KEY)
      # ========================================================================
      - name: üåê 4.1 MESH NETWORK ESTABLISHMENT
        run: |
          Write-Host "--- DEPLOYING TAILSCALE SECURE TUNNEL ---" -ForegroundColor Blue
          
          $Installer = "$env:TEMP\ts_install.msi"
          Write-Host "Downloading Tailscale..."
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $Installer
          
          Write-Host "Installing Drivers..."
          Start-Process msiexec.exe -ArgumentList "/i", "`"$Installer`"", "/quiet", "/norestart" -Wait
          Start-Sleep -Seconds 10
          
          Write-Host "Connecting with Hardcoded Key..."
          # Using the DIRECT_TS_KEY variable defined at the top
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:DIRECT_TS_KEY --hostname=TITAN-RDP-$env:GITHUB_RUN_ID --reset --accept-routes
          
          for($i=1; $i -le 15; $i++) {
              $IP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              if ($IP) {
                  Write-Host "‚úÖ Network Ready! IP: $IP" -ForegroundColor Green
                  echo "RDP_IP=$IP" >> $env:GITHUB_ENV
                  return
              }
              Write-Host "‚îÇ Handshake in progress... ($i/15)" -ForegroundColor Gray
              Start-Sleep -Seconds 4
          }

      # ========================================================================
      # PHASE 5: SOFTWARE DEPLOYMENT
      # ========================================================================
      - name: üì¶ 5.1 SOFTWARE STACK PROVISIONING
        run: |
          Write-Host "--- INSTALLING CHROME ---" -ForegroundColor Blue
          Invoke-WebRequest -Uri "https://dl.google.com/chrome/install/375.126/chrome_installer.exe" -OutFile "$env:TEMP\chrome.exe"
          Start-Process "$env:TEMP\chrome.exe" -ArgumentList "/silent", "/install" -Wait
          Write-Host "‚úÖ Chrome Installed." -ForegroundColor Green

      # ========================================================================
      # PHASE 6: ACCESS DASHBOARD (VIEW PASSWORD HERE)
      # ========================================================================
      - name: üîë 6.1 ACCESS CREDENTIALS DASHBOARD
        if: always()
        run: |
          $Pass = Get-Content "$env:TEMP\rdp_creds.txt" -ErrorAction SilentlyContinue
          $IP = if ($env:RDP_IP) { $env:RDP_IP } else { "CHECK_TAILSCALE_PANEL" }
          
          Write-Host "`n"
          Write-Host "==========================================================" -ForegroundColor Cyan
          Write-Host "             üöÄ RDP CONNECTION DETAILS                  " -ForegroundColor Cyan
          Write-Host "==========================================================" -ForegroundColor Cyan
          Write-Host "  üåê IP ADDRESS : $IP" -ForegroundColor White
          Write-Host "  üë§ USERNAME   : TITAN-ADMIN" -ForegroundColor Green
          Write-Host "  üîê PASSWORD   : $Pass" -ForegroundColor Yellow
          Write-Host "==========================================================" -ForegroundColor Cyan
          Write-Host "`n"

      # ========================================================================
      # PHASE 7: EXTENDED MONITORING (1000+ LINE GENERATOR)
      # ========================================================================
      - name: üõ°Ô∏è 7.1 HIGH-VERBOSITY SYSTEM MONITORING
        run: |
          $Duration = "${{ github.event.inputs.duration }}"
          switch ($Duration) {
              "1h" { $Mins = 60 }
              "3h" { $Mins = 180 }
              "5h40m" { $Mins = 340 }
          }
          
          $EndTime = (Get-Date).AddMinutes($Mins)
          
          while ((Get-Date) -lt $EndTime) {
              $Left = $EndTime - (Get-Date)
              $CPU = (Get-CimInstance Win32_Processor | Measure-Object -Property LoadPercentage -Average).Average
              $RAM = (Get-CimInstance Win32_OperatingSystem).FreePhysicalMemory
              $RDP_Status = Get-Service TermService | Select-Object -ExpandProperty Status
              
              Write-Host "`n[$(Get-Date -Format 'HH:mm:ss')] --- HEARTBEAT ---" -ForegroundColor Cyan
              Write-Host "‚îÇ Timer: $($Left.Hours)h $($Left.Minutes)m remaining"
              Write-Host "‚îÇ RDP Engine: $RDP_Status | CPU: $CPU% | RAM: $([math]::Round($RAM/1024, 2))MB"
              
              # Re-display password every 20 minutes
              if ($Left.Minutes % 20 -eq 0) {
                  $P = Get-Content "$env:TEMP\rdp_creds.txt"
                  Write-Host "‚îÇ [PASS-RECALL] Admin: TITAN-ADMIN | Pass: $P" -ForegroundColor Yellow
              }

              # Dummy lines to pad the log
              Write-Host "‚îÇ [Audit] Network socket 3389 state: Listen" -ForegroundColor Gray
              Write-Host "‚îÇ [Audit] Secure tunnel integrity: 100%" -ForegroundColor Gray
              Write-Host "‚îÇ [Audit] I/O Buffer Status: Normal" -ForegroundColor Gray
              
              Start-Sleep -Seconds 30
          }

      # ========================================================================
      # PHASE 8: TERMINATION
      # ========================================================================
      - name: üßπ 8.1 SECURE TERMINATION
        if: always()
        run: |
          Write-Host "Destroying session data..." -ForegroundColor Red
          Remove-LocalUser -Name "TITAN-ADMIN" -ErrorAction SilentlyContinue
          & "$env:ProgramFiles\Tailscale\tailscale.exe" down
          Write-Host "System Offline." -ForegroundColor Green
