name: üöÄ PREMIUM RDP SERVER ENHANCED

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Select Duration'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'

jobs:
  Premium-RDP-Setup:
    runs-on: windows-latest
    timeout-minutes: 360 # 6 hours limit
    
    steps:
      # SECTION 1: SYSTEM INITIALIZATION
      - name: üéØ INITIALIZING SYSTEM
        run: |
          Write-Host "------------------------------------------------------"
          Write-Host "ü§ñ PREMIUM WINDOWS RDP SERVER ACTIVATING" -ForegroundColor Yellow
          Write-Host "‚ö° Powered by Gemini AI Enhanced Script" -ForegroundColor Green
          Write-Host "üïí Requested Duration: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta
          Write-Host "------------------------------------------------------"
          
          $frames = @('‚£æ', '‚£Ω', '‚£ª', '‚¢ø', '‚°ø', '‚£ü', '‚£Ø', '‚£∑')
          for($i=0; $i -lt 20; $i++) {
              Write-Host "`rüöÄ Booting Kernel... $($frames[$i % 8])" -NoNewline -ForegroundColor Blue
              Start-Sleep -Milliseconds 100
          }
          Write-Host "`r‚úÖ System Ready for Deployment!             " -ForegroundColor Green

      # SECTION 2: REGISTRY & NETWORK OPTIMIZATION
      - name: üîß ADVANCED SYSTEM CONFIGURATION
        run: |
          Write-Host "`nüõ†Ô∏è  STARTING ADVANCED CONFIGURATION" -ForegroundColor Yellow
          
          $steps = @(
              @{Name="Enable Remote Desktop"; Script={ 
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
              }},
              @{Name="Disable NLA (Network Level Authentication)"; Script={
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
              }},
              @{Name="Set RDP Security Layer"; Script={
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
              }},
              @{Name="Configure Windows Firewall for RDP"; Script={
                  netsh advfirewall firewall add rule name="RDP-Inbound" dir=in action=allow protocol=TCP localport=3389 profile=any
                  netsh advfirewall firewall add rule name="RDP-Outbound" dir=out action=allow protocol=TCP localport=3389 profile=any
              }},
              @{Name="Optimizing TCP Stack"; Script={
                  netsh int tcp set global autotuninglevel=normal
                  netsh int tcp set global chimney=enabled
              }},
              @{Name="Disable Sleep/Hibernation"; Script={
                  powercfg /x -monitor-timeout-ac 0
                  powercfg /x -disk-timeout-ac 0
                  powercfg /x -standby-timeout-ac 0
              }},
              @{Name="Enabling RDP Services"; Script={
                  Set-Service -Name TermService -StartupType Automatic -ErrorAction SilentlyContinue
                  Start-Service -Name TermService -ErrorAction SilentlyContinue
              }}
          )
          
          foreach($step in $steps) {
              Write-Host "‚îÇ Processing: $($step.Name)..." -NoNewline -ForegroundColor White
              try {
                  & $step.Script
                  Write-Host "`r‚îÇ ‚úÖ SUCCESS: $($step.Name)" -ForegroundColor Green
              } catch {
                  Write-Host "`r‚îÇ ‚ö†Ô∏è  SKIPPED: $($step.Name)" -ForegroundColor Yellow
              }
              Start-Sleep -Milliseconds 200
          }

      # SECTION 3: USER CREATION & PERMISSIONS
      - name: üë§ CREATE PREMIUM USER ACCOUNT
        run: |
          Write-Host "`nüë§ GENERATING SECURE CREDENTIALS" -ForegroundColor Yellow
          
          function Generate-SecurePassword {
              $upper = 'ABCDEFGHJKLMNPQRSTUVWXYZ'
              $lower = 'abcdefghijkmnpqrstuvwxyz'
              $nums = '23456789'
              $spec = '!@#'
              $all = $upper + $lower + $nums + $spec
              
              $pw = ""
              $pw += $upper[(Get-Random -Max $upper.Length)]
              $pw += $lower[(Get-Random -Max $lower.Length)]
              $pw += $nums[(Get-Random -Max $nums.Length)]
              for($i=0; $i -lt 9; $i++) { $pw += $all[(Get-Random -Max $all.Length)] }
              return -join ($pw.ToCharArray() | Sort-Object {Get-Random})
          }

          $username = "PREMIUM-USER"
          $password = Generate-SecurePassword
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          Write-Host "‚îÇ Checking for existing accounts..." -ForegroundColor White
          Remove-LocalUser -Name $username -ErrorAction SilentlyContinue
          
          Write-Host "‚îÇ Creating account: $username..." -ForegroundColor White
          New-LocalUser -Name $username -Password $securePass -AccountNeverExpires -Description "Premium RDP Access"
          
          Write-Host "‚îÇ Elevating privileges..." -ForegroundColor White
          Add-LocalGroupMember -Group "Administrators" -Member $username -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username -ErrorAction SilentlyContinue
          
          # Save for next steps
          echo "$username" > $env:TEMP\rdp_user.txt
          echo "$password" > $env:TEMP\rdp_pass.txt
          
          Write-Host "‚úÖ User Account $username is Ready!" -ForegroundColor Green

      # SECTION 4: NETWORK TUNNELING (TAILSCALE)
      - name: üåê SETUP REMOTE NETWORK ACCESS
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host "`nüåê ESTABLISHING NETWORK TUNNEL" -ForegroundColor Yellow
          
          $msiPath = "$env:TEMP\tailscale.msi"
          Write-Host "‚îÇ Downloading Tailscale Client..." -ForegroundColor White
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath
          
          Write-Host "‚îÇ Installing Network Driver..." -ForegroundColor White
          Start-Process msiexec.exe -ArgumentList "/i", "`"$msiPath`"", "/quiet", "/norestart" -Wait
          
          Start-Sleep -Seconds 5
          
          Write-Host "‚îÇ Connecting to Mesh Network..." -ForegroundColor White
          if ($env:TAILSCALE_AUTH_KEY) {
              & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=GH-RDP-$env:GITHUB_RUN_ID
          } else {
              Write-Host "‚îÇ ‚ö†Ô∏è  Warning: TAILSCALE_AUTH_KEY not found in Secrets. Connection might fail." -ForegroundColor Red
          }
          
          Write-Host "‚îÇ Fetching assigned IP..." -NoNewline -ForegroundColor Blue
          for($i=0; $i -lt 10; $i++) {
              $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              if ($ip) { 
                  echo "RDP_IP=$ip" >> $env:GITHUB_ENV
                  Write-Host "`r‚úÖ Remote IP: $ip" -ForegroundColor Green
                  break 
              }
              Start-Sleep -Seconds 2
          }

      # SECTION 5: SOFTWARE INSTALLATION (OPTIONAL)
      - name: üì¶ INSTALLING TOOLS (CHROME/VSCODE)
        run: |
          Write-Host "`nüì¶ INSTALLING PRODUCTIVITY SUITE" -ForegroundColor Yellow
          Write-Host "‚îÇ Installing Google Chrome..." -ForegroundColor White
          $chromePath = "$env:TEMP\chrome_installer.exe"
          Invoke-WebRequest -Uri "https://dl.google.com/chrome/install/375.126/chrome_installer.exe" -OutFile $chromePath
          Start-Process $chromePath -ArgumentList "/silent", "/install" -Wait
          Write-Host "‚îÇ ‚úÖ Chrome Installed" -ForegroundColor Green

      # SECTION 6: DISPLAY CREDENTIALS (THE PART YOU REQUESTED)
      - name: üéâ CONNECTION DETAILS (READ CAREFULLY)
        run: |
          $user = Get-Content $env:TEMP\rdp_user.txt
          $pass = Get-Content $env:TEMP\rdp_pass.txt
          $ip = $env:RDP_IP
          if (-not $ip) { $ip = "Check Tailscale Dashboard" }

          Write-Host "`n"
          Write-Host "*****************************************************" -ForegroundColor Cyan
          Write-Host "* üöÄ PREMIUM RDP CREDENTIALS            *" -ForegroundColor Cyan
          Write-Host "*****************************************************" -ForegroundColor Cyan
          Write-Host "* *" -ForegroundColor Cyan
          Write-Host "* üåê IP ADDRESS : $ip " -ForegroundColor White
          Write-Host "* üë§ USERNAME    : $user " -ForegroundColor Green
          Write-Host "* üîê PASSWORD    : $pass " -ForegroundColor Yellow
          Write-Host "* üìç PORT        : 3389 " -ForegroundColor White
          Write-Host "* *" -ForegroundColor Cyan
          Write-Host "*****************************************************" -ForegroundColor Cyan
          Write-Host "* How to connect:                                 *" -ForegroundColor White
          Write-Host "* 1. Use 'Remote Desktop Connection' on Windows   *" -ForegroundColor White
          Write-Host "* 2. Enter the IP above                           *" -ForegroundColor White
          Write-Host "* 3. Use the Username and Password shown above    *" -ForegroundColor White
          Write-Host "*****************************************************" -ForegroundColor Cyan

      # SECTION 7: LONG-RUNNING MONITORING (FILLS UP TO 500+ LINES LOGS)
      - name: ‚è≥ SESSION MAINTENANCE & KEEP ALIVE
        run: |
          $duration = "${{ github.event.inputs.duration }}"
          switch ($duration) {
              "1h" { $minutes = 60 }
              "3h" { $minutes = 180 }
              "5h40m" { $minutes = 340 }
          }
          
          $endTime = (Get-Date).AddMinutes($minutes)
          Write-Host "`nüîÑ SESSION MONITORING STARTED" -ForegroundColor Magenta
          Write-Host "‚îÇ Session expires at: $($endTime.ToString('HH:mm:ss'))" -ForegroundColor White
          
          # This loop will print status updates to keep the log over 500 lines over time
          do {
              $timeLeft = $endTime - (Get-Date)
              $ts = [string]::Format("{0:D2}h:{1:D2}m:{2:D2}s", $timeLeft.Hours, $timeLeft.Minutes, $timeLeft.Seconds)
              
              # Health Checks
              $cpuLoad = (Get-CimInstance Win32_Processor | Measure-Object -Property LoadPercentage -Average).Average
              $memLoad = (Get-CimInstance Win32_OperatingSystem).FreePhysicalMemory
              $rdpStatus = Get-Service TermService | Select-Object -ExpandProperty Status
              
              Write-Host "`n[$(Get-Date -Format 'HH:mm:ss')] --- SYSTEM STATUS ---" -ForegroundColor Cyan
              Write-Host "‚îÇ Timer: $ts remaining" -ForegroundColor Green
              Write-Host "‚îÇ RDP Service: $rdpStatus" -ForegroundColor White
              Write-Host "‚îÇ CPU Load: $cpuLoad%" -ForegroundColor White
              Write-Host "‚îÇ Free RAM: $([math]::Round($memLoad/1KB, 2)) MB" -ForegroundColor White
              
              # Preventive Restart of Service if stopped
              if ($rdpStatus -ne 'Running') { 
                  Write-Host "‚îÇ ‚ö†Ô∏è  RDP Service stopped! Restarting..." -ForegroundColor Red
                  Start-Service TermService 
              }

              # Dummy lines to ensure log richness/length
              Write-Host "‚îÇ [Log] Heartbeat pulse sent to kernel..." -ForegroundColor Gray
              Write-Host "‚îÇ [Log] Refreshing firewall rules..." -ForegroundColor Gray
              Write-Host "‚îÇ [Log] Monitoring active connections: $((Get-NetTCPConnection -LocalPort 3389 -ErrorAction SilentlyContinue).Count)" -ForegroundColor Gray
              
              Start-Sleep -Seconds 60
          } while ($timeLeft.TotalSeconds -gt 0)

      # SECTION 8: AUTOMATED CLEANUP
      - name: üßπ FINAL SYSTEM CLEANUP
        if: always()
        run: |
          Write-Host "`nüßπ WIPING SESSION DATA..." -ForegroundColor Yellow
          $user = Get-Content $env:TEMP\rdp_user.txt -ErrorAction SilentlyContinue
          
          if ($user) {
              Write-Host "‚îÇ Removing User: $user"
              Remove-LocalUser -Name $user -ErrorAction SilentlyContinue
          }
          
          Write-Host "‚îÇ Stopping Tailscale..."
          & "$env:ProgramFiles\Tailscale\tailscale.exe" down --accept-risk=all -ErrorAction SilentlyContinue
          
          Write-Host "‚îÇ Cleaning Temp Files..."
          Remove-Item "$env:TEMP\rdp_pass.txt" -ErrorAction SilentlyContinue
          Remove-Item "$env:TEMP\rdp_user.txt" -ErrorAction SilentlyContinue
          
          Write-Host "‚úÖ Cleanup Complete. Goodbye!" -ForegroundColor Green